<!DOCTYPE html>
<html lang="en">
  <meta charset="UTF-8" />
  <!-- Import Webcomponents polyfill for older browsers -->
  <link rel="icon" type="image/png" href="static/favicon.png" />

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Proyector de Embeddings Literarios</title>
    <style>
      body {
        margin: 0;
        font-family: "Roboto", sans-serif;
        height: 100vh;
        overflow: hidden;
      }

      #appbar {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 24px;
        height: 60px;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1;
        color: white;
        background: #003153;
      }

      #appbar .logo {
        font-size: 18px;
        font-weight: 300;
      }

      .icons {
        display: flex;
      }

      .icons a {
        color: white;
      }

      .center-section img {
        width: 20%;
        max-width: 20%;
      }

      .audios {
        display: flex;
      }

      .center-section {
        position: absolute;
        left: 50%;
        transform: translateX(-12%);
      }

      #container {
        margin-top: 60px;
        display: flex;
        transition: margin-left 0.3s ease;
        justify-content: center;
        align-items: center;
        height: calc(100vh - 60px);
        width: 100%;
      }

      #3d-graph {
        flex-grow: 1;
        transition: margin-left 0.3s ease;
      }

      #popup {
        position: fixed;
        box-sizing: calc(65%);
        top: 60px;
        left: 0;
        width: 20%;
        height: calc(100% - 60px);
        background: white;
        border-left: 1px solid #ccc;
        box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        overflow-y: auto;
        overflow-x: visible;
        z-index: 2;
        margin-right: -10%;
        transition: margin-left 0.3s ease;
        max-width: 90%;
      }

      #toggle-popup-btn {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 15px;
        cursor: pointer;
        font-size: 14px;
        border-radius: 5px;
        transform: translateX(+5%);
        transition: margin-left 0.3s ease;
      }

      #follow-author-btn {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        cursor: pointer;
        font-size: 14px;
        border-radius: 5px;
        margin-top: 20px;
      }

      #follow-author-btn:hover {
        background-color: #0056b3;
      }

      #author-info-container {
        width: 90%;
        background: #ffffff;
        border-radius: 5px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        position: relative;
        align-items: flex-start;
        left: 0;
      }
      #Sign-In-btn {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 15px;
        cursor: pointer;
        font-size: 14px;
        border-radius: 5px;
        transform: translateX(-60%);
        transition: margin-left 0.3s ease;
      }

      #Sign-In-btn:hover {
        background-color: #0056b3;
      }

      #toggle-popup-btn:hover {
        background-color: #0056b3;
      }
    </style>
  </head>

  <body>
    <div id="appbar">
      <div>
        Authors links
        <button
          id="toggle-popup-btn"
          onclick="togglePopup();"
          title="Toggle Popup"
        >
          Show Stories
        </button>
      </div>
      <div class="center-section">
        <img src="static/Coem.png" alt="Logo" />
      </div>
      <div>
        <button
          onclick="window.location.href='Coem.org'"
          id="Sign-In-btn"
          title="Toggle Sign in"
        >
          Sign In
        </button>
      </div>
    </div>

    <div id="container">
      <div id="3d-graph"></div>
    </div>

    <div id="popup">
      <div id="author-info-container">></div>
      <button id="follow-author-btn">Follow Author</button>
    </div>

    <script src="//unpkg.com/3d-force-graph"></script>
    <script>


      function togglePopup() {
        var popup = document.getElementById("popup");
        var container = document.getElementById("container");
        var graph = document.getElementById("3d-graph");
        var toggleLink = document.getElementById("toggle-popup-btn");

        if (popup.style.display === "none" || popup.style.display === "") {
          popup.style.display = "flex";
          popup.style.width = "25%;";
          toggleLink.textContent = "Hide Stories";
          container.style.width = "calc(100% - 25%)";
          container.style.marginLeft = "25%";

          loadAuthorInfo();
        } else {
          popup.style.display = "none";
          toggleLink.textContent = "Show Stories";
          container.style.width = "100%";
          container.style.marginLeft = "0";
        }
      }
      function loadAuthorInfo( autor ) {
        if ( !autor ) { return }
        fetch("static/author-info_smaller.html")
          .then((response) => response.text())
          .then((data) => {
            var rendered = data
              .replace("{{name}}", autor.id)
              .replace("{{country}}", autor.country)
              .replace("{{birthYear}}", autor.birth_year)
              .replace("{{deathYear}}", autor.death_year)
              .replace("{{Genre}}", autor.genre)
              .replace(
                "{{exampleStory}}",
                autor.story_name
              );
            document.getElementById("author-info-container").innerHTML =
              rendered;
            document.getElementById("popup-image").src = `/static/${autor.image}`;
            document.getElementById("popup-audio").src = `/static/${autor.audio}`;
          })
          .catch((error) => console.error("Error loading the box:", error));
      }

      // Ensure the popup is initially hidden
      document.addEventListener("DOMContentLoaded", function () {
        var popup = document.getElementById("popup");
        var container = document.getElementById("container");
        var toggleLink = document.getElementById("toggle-popup-btn");
        toggleLink.textContent = "Hide Stories";
        popup.style.display = "flex";
        container.style.marginLeft = "25%";
        container.style.width = "calc(100% - 25%)";
      });

      async function fetchJSON() {
        try {
          const response = await fetch("static/authorLinksSmaller_new.json");
          const gData = await response.json();
          return gData;
        } catch (error) {
          console.error("Error fetching JSON:", error);
          throw error; // Optionally rethrow the error or handle it as needed
        }
      }

      fetchJSON().then((gData) => {
        // cross-link node objects
        gData.links.forEach((link) => {
          const a = gData.nodes.find(node => node.id === link.source );
          const b = gData.nodes.find(node => node.id === link.target );
          !a.neighbors && (a.neighbors = []);
          !b.neighbors && (b.neighbors = []);
          a.neighbors.push(b);
          b.neighbors.push(a);

          !a.links && (a.links = []);
          !b.links && (b.links = []);
          a.links.push(link);
          b.links.push(link);
        });

        const highlightNodes = new Set();
        const highlightLinks = new Set();
        function highlightNodeAndLinks( node ){
          highlightNodes.clear();
          highlightLinks.clear();
          if (node) {
          highlightNodes.add(node);
          node.neighbors.forEach(neighbor => highlightNodes.add(neighbor));
          node.links.forEach(link => highlightLinks.add(link));
          updateHighlight();
          }
        }

        const Graph = ForceGraph3D()(
          // TODO missing selecting an author and untangle it, also when an author is selected Cahnge the authors fill
          document.getElementById("3d-graph")
        )
          .graphData(gData)
          .nodeAutoColorBy("group")
          .nodeLabel((node) => `${node.id}: ${node.country}`)
          .onNodeClick((node) => {
            autor = node;
            loadAuthorInfo(autor);
            highlightNodeAndLinks( node );
          })
          .linkWidth((link)=> {
            return highlightLinks.has(link) ? 1 : 0.2;
          })
          .linkColor((link) => {
            return highlightLinks.has(link) ? 'rgba(0,255,255,0.2)' : 'rgba(200,200,200,0.2)';
          })
          .linkOpacity((link)=> {
            return highlightLinks.has(link) ? 1 : 0.2;
          });

        function updateHighlight() {
          // trigger update of highlighted objects in scene
          Graph
          .nodeColor(Graph.nodeColor())
          .linkWidth(Graph.linkWidth());
        }

        var autor = gData.nodes.find(node => node.id === 'Gabriel García Márquez' );
        loadAuthorInfo( autor );
        highlightNodeAndLinks( autor );

        function followAuthor() {
          const node = autor;
          // Aim at node from outside it
          const distance = 40;
          const distRatio = 1 + distance / Math.hypot(node.x, node.y, node.z);

          const newPos =
            node.x || node.y || node.z
              ? {
                  x: node.x * distRatio,
                  y: node.y * distRatio,
                  z: node.z * distRatio,
                }
              : { x: 0, y: 0, z: distance }; // special case if node is in (0,0,0)

          Graph.cameraPosition(
            newPos, // new position
            node, // lookAt ({ x, y, z })
            3000 // ms transition duration
          );

          highlightNodeAndLinks( node );
        }

        // Get the button element
        const changeAuthorBtn = document.getElementById('follow-author-btn');

        // Add click event listener to the button
        changeAuthorBtn.addEventListener('click', followAuthor);
      });

    </script>
  </body>
</html>
